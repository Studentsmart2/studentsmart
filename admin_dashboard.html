<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - StudentsMart</title>
    <link rel="icon" href="https://i.ibb.co/1YBpx2KS/logo.png">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #6C5CE7;
            --success: #00B894;
            --warning: #FDCB6E;
            --danger: #E17055;
            --info: #0984E3;
            --dark: #2D3436;
            --light: #F5F6FA;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light);
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary) 0%, #A29BFE 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stats-card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .sidebar {
            background-color: white;
            min-height: 100vh;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .nav-pills .nav-link {
            color: var(--dark);
            margin-bottom: 0.5rem;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .nav-pills .nav-link:hover {
            background-color: rgba(108, 92, 231, 0.1);
        }

        .nav-pills .nav-link.active {
            background-color: var(--primary);
        }

        .table-hover tbody tr:hover {
            background-color: rgba(108, 92, 231, 0.05);
        }

        .badge {
            padding: 0.5rem 0.75rem;
            font-weight: 500;
        }

        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
</head>
<body>
    <!-- Admin Header -->
    <div class="admin-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0"><i class="fas fa-user-shield me-2"></i>Admin Dashboard</h2>
                    <small>Welcome back, Admin</small>
                </div>
                <div>
                    <button class="btn btn-light" onclick="window.location.href='/'">
                        <i class="fas fa-home me-2"></i>Back to Home
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-3">
                <div class="nav flex-column nav-pills" id="adminTabs" role="tablist">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" type="button" role="tab">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </button>
                    <button class="nav-link" id="users-tab" data-bs-toggle="pill" data-bs-target="#users" type="button" role="tab">
                        <i class="fas fa-users me-2"></i> Users
                    </button>
                    <button class="nav-link" id="listings-tab" data-bs-toggle="pill" data-bs-target="#listings" type="button" role="tab">
                        <i class="fas fa-list me-2"></i> Listings
                    </button>
                    <button class="nav-link" id="reports-tab" data-bs-toggle="pill" data-bs-target="#reports" type="button" role="tab">
                        <i class="fas fa-flag me-2"></i> Reports
                        <span class="badge bg-danger ms-2" id="reportsBadge">0</span>
                    </button>
                    <button class="nav-link" id="colleges-tab" data-bs-toggle="pill" data-bs-target="#colleges" type="button" role="tab">
                        <i class="fas fa-university me-2"></i> Colleges
                    </button>
                    <button class="nav-link" id="activity-tab" data-bs-toggle="pill" data-bs-target="#activity" type="button" role="tab">
                        <i class="fas fa-history me-2"></i> Activity Log
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 p-4">
                <div class="tab-content">
                    <!-- Dashboard Tab -->
                    <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                        <!-- Stats Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card stats-card bg-primary text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Total Users</h5>
                                        <h2 id="totalUsers">0</h2>
                                        <small>Last 30 days: <span id="newUsers">0</span></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stats-card bg-success text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Verified Users</h5>
                                        <h2 id="verifiedUsers">0</h2>
                                        <small>Unverified: <span id="unverifiedUsers">0</span></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stats-card bg-info text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Total Listings</h5>
                                        <h2 id="totalListings">0</h2>
                                        <small>Last 30 days: <span id="newListings">0</span></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stats-card bg-warning text-dark">
                                    <div class="card-body">
                                        <h5 class="card-title">Fake Warnings</h5>
                                        <h2 id="fakeWarnings">0</h2>
                                        <small>Pending: <span id="pendingReports">0</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sales Stats Row -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card stats-card bg-success text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Total Sales</h5>
                                        <h2 id="totalSalesCount">0</h2>
                                        <small>Confirmed transactions</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stats-card bg-warning text-dark">
                                    <div class="card-body">
                                        <h5 class="card-title">Pending Sales</h5>
                                        <h2 id="pendingSalesCount">0</h2>
                                        <small>Awaiting confirmation</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stats-card bg-info text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Recent Sales</h5>
                                        <h2 id="recentSalesCount">0</h2>
                                        <small>Last 30 days</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card stats-card bg-danger text-white">
                                    <div class="card-body">
                                        <h5 class="card-title">Denied Sales</h5>
                                        <h2 id="deniedSalesCount">0</h2>
                                        <small>Buyer declined</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts -->
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header bg-white">
                                        <h5 class="mb-0">User Growth</h5>
                                    </div>
                                    <div class="card-body chart-container">
                                        <canvas id="userGrowthChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header bg-white">
                                        <h5 class="mb-0">Listing Growth</h5>
                                    </div>
                                    <div class="card-body chart-container">
                                        <canvas id="listingGrowthChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header bg-white">
                                        <h5 class="mb-0">Categories Distribution</h5>
                                    </div>
                                    <div class="card-body chart-container">
                                        <canvas id="categoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header bg-white">
                                        <h5 class="mb-0">Sales by Category</h5>
                                    </div>
                                    <div class="card-body chart-container">
                                        <canvas id="salesByCategoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sales Transactions Table -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Sales Transactions</h5>
                                        <div class="d-flex gap-2">
                                            <select class="form-select form-select-sm" id="salesStatusFilter" style="width: 150px;">
                                                <option value="">All Sales</option>
                                                <option value="confirmed">Confirmed</option>
                                                <option value="pending">Pending</option>
                                                <option value="denied">Denied</option>
                                            </select>
                                            <button class="btn btn-sm btn-success" onclick="exportSalesData()">
                                                <i class="fas fa-download me-1"></i>Export CSV
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Item</th>
                                                        <th>Price</th>
                                                        <th>Category</th>
                                                        <th>Seller</th>
                                                        <th>Buyer</th>
                                                        <th>College</th>
                                                        <th>Status</th>
                                                        <th>Sold Date</th>
                                                        <th>Confirmed</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="salesTableBody">
                                                    <tr>
                                                        <td colspan="10" class="text-center py-3">
                                                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                                            Loading sales data...
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                                        <div>
                                            Showing <span id="salesStart">0</span> to <span id="salesEnd">0</span> of <span id="salesTotal">0</span> sales
                                        </div>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-sm btn-outline-secondary" id="salesPrevPage" disabled>
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" id="salesNextPage" disabled>
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Tab -->
                    <div class="tab-pane fade" id="users" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">User Management</h5>
                                <div class="d-flex gap-2">
                                    <div class="input-group input-group-sm" style="width: 250px;">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
                                    </div>
                                    <select class="form-select form-select-sm" id="userFilter" style="width: 150px;">
                                        <option value="">All Users</option>
                                        <option value="verified">Verified</option>
                                        <option value="unverified">Unverified</option>
                                        <option value="admin">Admins</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="50"><input type="checkbox" class="form-check-input" id="selectAllUsers"></th>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>College</th>
                                                <th>Verified</th>
                                                <th>Listings</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody">
                                            <tr><td colspan="8" class="text-center py-3">Loading users...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                                <div class="d-flex gap-2">
                                    <select class="form-select form-select-sm" id="bulkUserAction" style="width: 150px;">
                                        <option value="">Bulk Actions</option>
                                        <option value="verify">Verify Selected</option>
                                        <option value="unverify">Unverify Selected</option>
                                        <option value="delete">Delete Selected</option>
                                    </select>
                                    <button class="btn btn-sm btn-primary" id="applyBulkAction">Apply</button>
                                </div>
                                <div>
                                    Showing <span id="userStart">1</span> to <span id="userEnd">10</span> of <span id="userTotal">0</span> users
                                </div>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-secondary" id="userPrevPage" disabled>
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="userNextPage" disabled>
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Listings Tab -->
                    <div class="tab-pane fade" id="listings" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Listing Management</h5>
                                <div class="d-flex gap-2">
                                    <div class="input-group input-group-sm" style="width: 250px;">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="listingSearch" placeholder="Search listings...">
                                    </div>
                                    <select class="form-select form-select-sm" id="listingFilter" style="width: 150px;">
                                        <option value="">All Listings</option>
                                        <option value="fake">Fake Warnings</option>
                                        <option value="recent">Recent</option>
                                        <option value="old">Old</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="50"><input type="checkbox" class="form-check-input" id="selectAllListings"></th>
                                                <th>ID</th>
                                                <th>Title</th>
                                                <th>Price</th>
                                                <th>Category</th>
                                                <th>Seller</th>
                                                <th>Fake Warning</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="listingsTableBody">
                                            <tr><td colspan="8" class="text-center py-3">Loading listings...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                                <div class="d-flex gap-2">
                                    <select class="form-select form-select-sm" id="bulkListingAction" style="width: 150px;">
                                        <option value="">Bulk Actions</option>
                                        <option value="flag">Flag as Fake</option>
                                        <option value="unflag">Remove Flag</option>
                                        <option value="delete">Delete</option>
                                    </select>
                                    <button class="btn btn-sm btn-primary" id="applyBulkListingAction">Apply</button>
                                </div>
                                <div>
                                    Showing <span id="listingStart">1</span> to <span id="listingEnd">10</span> of <span id="listingTotal">0</span> listings
                                </div>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-secondary" id="listingPrevPage" disabled>
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="listingNextPage" disabled>
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Tab -->
                    <div class="tab-pane fade" id="reports" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Reported Content</h5>
                                <select class="form-select form-select-sm" id="reportFilter" style="width: 150px;">
                                    <option value="">All Reports</option>
                                    <option value="pending">Pending</option>
                                    <option value="resolved">Resolved</option>
                                </select>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Listing</th>
                                                <th>Reporter</th>
                                                <th>Reason</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="reportsTableBody">
                                            <tr><td colspan="7" class="text-center py-3">Loading reports...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                                <div>
                                    Showing <span id="reportStart">1</span> to <span id="reportEnd">10</span> of <span id="reportTotal">0</span> reports
                                </div>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-secondary" id="reportPrevPage" disabled>
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="reportNextPage" disabled>
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Colleges Tab -->
                    <div class="tab-pane fade" id="colleges" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">College Management</h5>
                                <div class="input-group input-group-sm" style="width: 250px;">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="collegeSearch" placeholder="Search colleges...">
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>College Name</th>
                                                <th>Users</th>
                                                <th>Listings</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="collegesTableBody">
                                            <tr><td colspan="4" class="text-center py-3">Loading colleges...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                                <div>
                                    Showing <span id="collegeStart">1</span> to <span id="collegeEnd">10</span> of <span id="collegeTotal">0</span> colleges
                                </div>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-secondary" id="collegePrevPage" disabled>
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="collegeNextPage" disabled>
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Log Tab -->
                    <div class="tab-pane fade" id="activity" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Admin Activity Log</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Admin</th>
                                                <th>Action</th>
                                                <th>Target</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="activityTableBody">
                                            <tr><td colspan="5" class="text-center py-3">Loading activity...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                                <div>
                                    Showing <span id="activityStart">1</span> to <span id="activityEnd">10</span> of <span id="activityTotal">0</span> activities
                                </div>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-secondary" id="activityPrevPage" disabled>
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="activityNextPage" disabled>
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Global Variables
        let currentUserPage = 1;
        let currentListingPage = 1;
        let currentCollegePage = 1;
        let currentSalesPage = 1;
        const usersPerPage = 10;
        const listingsPerPage = 10;
        const collegesPerPage = 10;
        const salesPerPage = 10;
        let allSalesData = [];
        let allCollegesData = [];
        let salesChartsInitialized = false;

        // Utility: Show Alert
        function showAlert(title, message, type = 'info') {
            Swal.fire({
                title: title,
                text: message,
                icon: type,
                confirmButtonColor: '#6C5CE7'
            });
        }

        // ======================
        // LOAD ADMIN DATA
        // ======================
        async function loadAdminData() {
            try {
                const response = await fetch('/admin/dashboard', {
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('Failed to load admin data');

                const data = await response.json();

                // Update stats
                document.getElementById('totalUsers').textContent = data.stats.total_users || 0;
                document.getElementById('verifiedUsers').textContent = data.stats.verified_users || 0;
                document.getElementById('unverifiedUsers').textContent = (data.stats.total_users || 0) - (data.stats.verified_users || 0);
                document.getElementById('totalListings').textContent = data.stats.total_listings || 0;
                document.getElementById('fakeWarnings').textContent = data.stats.fake_warnings || 0;

                if (data.stats.pending_reports) {
                    document.getElementById('reportsBadge').textContent = data.stats.pending_reports;
                } else {
                    document.getElementById('reportsBadge').style.display = 'none';
                }

                // Load sales stats
                await loadSalesStats();

                // Load colleges
                await loadColleges();

                // Load users and listings
                loadAdminUsers();
                loadAdminListings();

                // Initialize charts
                initCharts();

            } catch (error) {
                console.error('Error loading admin data:', error);
                showAlert('Error', 'Failed to load admin dashboard', 'error');
            }
        }

        // ======================
        // SALES STATS
        // ======================
        async function loadSalesStats() {
            try {
                const response = await fetch('/api/admin/sales-stats', {
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('Failed to load sales stats');

                const data = await response.json();

                document.getElementById('totalSalesCount').textContent = data.total_sales || 0;
                document.getElementById('pendingSalesCount').textContent = data.pending_sales || 0;
                document.getElementById('recentSalesCount').textContent = data.recent_sales || 0;
                document.getElementById('deniedSalesCount').textContent = data.denied_sales || 0;

                allSalesData = data.recent_sold_items || [];
                displaySalesTable(allSalesData);

                if (typeof Chart !== 'undefined') {
                    createSalesCharts(data);
                }

            } catch (error) {
                console.error('Error loading sales stats:', error);
            }
        }

        function displaySalesTable(salesData, page = 1) {
            const tableBody = document.getElementById('salesTableBody');
            if (!tableBody) return;

            const start = (page - 1) * salesPerPage;
            const end = start + salesPerPage;
            const paginatedData = salesData.slice(start, end);

            if (!salesData || salesData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4">No sales transactions found</td></tr>';
                return;
            }

            tableBody.innerHTML = paginatedData.map(sale => `
                <tr>
                    <td><span class="badge bg-secondary">#${sale.id}</span></td>
                    <td><strong>${sale.listing_title || 'Deleted Listing'}</strong></td>
                    <td><strong class="text-success">₹${sale.listing_price || 0}</strong></td>
                    <td><span class="badge bg-info">${(sale.listing_category || 'N/A').toUpperCase()}</span></td>
                    <td>${sale.seller_name}</td>
                    <td>${sale.buyer_name}</td>
                    <td><small>${sale.seller_college}</small></td>
                    <td><span class="badge ${getSalesStatusBadgeClass(sale.status)}">${sale.status.toUpperCase()}</span></td>
                    <td><small>${formatSalesDate(sale.sold_at)}</small></td>
                    <td><small>${sale.confirmed_at ? formatSalesDate(sale.confirmed_at) : '-'}</small></td>
                </tr>
            `).join('');

            updateSalesPagination(salesData.length, page);
        }

        function getSalesStatusBadgeClass(status) {
            switch(status) {
                case 'confirmed': return 'bg-success';
                case 'pending': return 'bg-warning text-dark';
                case 'denied': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function formatSalesDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function updateSalesPagination(total, currentPage) {
            const totalPages = Math.ceil(total / salesPerPage);
            const start = total === 0 ? 0 : (currentPage - 1) * salesPerPage + 1;
            const end = Math.min(currentPage * salesPerPage, total);

            document.getElementById('salesStart').textContent = start;
            document.getElementById('salesEnd').textContent = end;
            document.getElementById('salesTotal').textContent = total;

            document.getElementById('salesPrevPage').disabled = currentPage === 1;
            document.getElementById('salesNextPage').disabled = currentPage === totalPages || totalPages === 0;
        }

        function exportSalesData() {
            const filterValue = document.getElementById('salesStatusFilter').value;
            let dataToExport = filterValue === '' ? allSalesData : allSalesData.filter(sale => sale.status === filterValue);

            if (dataToExport.length === 0) {
                showAlert('No Data', 'No sales data to export', 'info');
                return;
            }

            let csv = 'ID,Item Title,Price,Category,Seller Name,Seller Email,Buyer Name,Buyer Email,College,Status,Sold Date,Confirmed Date\n';

            dataToExport.forEach(sale => {
                csv += `${sale.id},"${sale.listing_title}",${sale.listing_price},"${sale.listing_category || 'N/A'}","${sale.seller_name}","${sale.seller_email || ''}","${sale.buyer_name}","${sale.buyer_email}","${sale.seller_college}","${sale.status}","${sale.sold_at}","${sale.confirmed_at || 'N/A'}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sales_report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // ======================
        // USERS MANAGEMENT
        // ======================
        async function loadAdminUsers(page = 1, search = '', filter = '') {
            try {
                const response = await fetch(`/admin/dashboard?page=${page}&search=${search}&filter=${filter}`, {
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('Failed to load users');

                const data = await response.json();
                const usersTable = document.getElementById('usersTableBody');
                usersTable.innerHTML = data.users.map(user => `
                    <tr>
                        <td><input type="checkbox" class="form-check-input user-checkbox" value="${user.id}"></td>
                        <td>${user.id}</td>
                        <td>${user.full_name || 'N/A'}</td>
                        <td>${user.email}</td>
                        <td>${user.college || 'N/A'}</td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input toggle-verification" type="checkbox" data-user-id="${user.id}" ${user.is_verified ? 'checked' : ''}>
                            </div>
                        </td>
                        <td>${user.listings_count}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="adminDeleteUser(${user.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('userStart').textContent = (page - 1) * usersPerPage + 1;
                document.getElementById('userEnd').textContent = Math.min(page * usersPerPage, data.stats.total_users);
                document.getElementById('userTotal').textContent = data.stats.total_users;

                document.getElementById('userPrevPage').disabled = page <= 1;
                document.getElementById('userNextPage').disabled = page * usersPerPage >= data.stats.total_users;

                currentUserPage = page;

            } catch (error) {
                showAlert('Error', error.message, 'error');
            }
        }

        async function adminDeleteUser(userId) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "This will delete the user and all their listings!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/admin/delete-user/${userId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });

                    if (!response.ok) throw new Error('Failed to delete user');

                    showAlert('Success', 'User deleted successfully', 'success');
                    loadAdminData();
                } catch (error) {
                    showAlert('Error', error.message, 'error');
                }
            }
        }

        // ======================
        // LISTINGS MANAGEMENT
        // ======================
        async function loadAdminListings(page = 1, search = '', filter = '') {
            try {
                const response = await fetch(`/admin/dashboard?page=${page}&search=${search}&filter=${filter}`, {
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('Failed to load listings');

                const data = await response.json();
                const listingsTable = document.getElementById('listingsTableBody');

                if (!data.listings || data.listings.length === 0) {
                    listingsTable.innerHTML = '<tr><td colspan="8" class="text-center py-3">No listings found</td></tr>';
                    return;
                }

                listingsTable.innerHTML = data.listings.map(listing => `
                    <tr>
                        <td><input type="checkbox" class="form-check-input listing-checkbox" value="${listing.id}"></td>
                        <td>${listing.id}</td>
                        <td>${listing.title}</td>
                        <td>₹${listing.price}</td>
                        <td>${listing.category}</td>
                        <td>${listing.seller_name}</td>
                        <td><span class="badge ${listing.is_fake_warning ? 'bg-danger' : 'bg-success'}">${listing.is_fake_warning ? 'Flagged' : 'Clean'}</span></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-warning" onclick="adminToggleFakeWarning(${listing.id}, ${!listing.is_fake_warning})">
                                    <i class="fas fa-flag"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="adminDeleteListing(${listing.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('listingStart').textContent = (page - 1) * listingsPerPage + 1;
                document.getElementById('listingEnd').textContent = Math.min(page * listingsPerPage, data.stats.total_listings);
                document.getElementById('listingTotal').textContent = data.stats.total_listings;

                currentListingPage = page;

            } catch (error) {
                showAlert('Error', error.message, 'error');
            }
        }

        async function adminDeleteListing(listingId) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "This will permanently delete the listing!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/admin/delete-listing/${listingId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });

                    if (!response.ok) throw new Error('Failed to delete listing');

                    showAlert('Success', 'Listing deleted successfully', 'success');
                    loadAdminData();
                } catch (error) {
                    showAlert('Error', error.message, 'error');
                }
            }
        }

        async function adminToggleFakeWarning(listingId, setFlagged) {
            try {
                const response = await fetch(`/admin/toggle-fake-warning/${listingId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('Failed to update warning');

                showAlert('Success', 'Listing status updated', 'success');
                loadAdminListings(currentListingPage);
            } catch (error) {
                showAlert('Error', error.message, 'error');
            }
        }

        // ======================
        // COLLEGES MANAGEMENT
        // ======================
        async function loadColleges(page = 1, search = '') {
            try {
                const response = await fetch(`/admin/colleges?page=${page}&search=${search}`, {
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('Failed to load colleges');

                const data = await response.json();
                allCollegesData = data.colleges || [];
                displayCollegesTable(allCollegesData, page);

            } catch (error) {
                console.error('Error loading colleges:', error);
            }
        }

        function displayCollegesTable(colleges, page = 1) {
            const tableBody = document.getElementById('collegesTableBody');
            if (!tableBody) return;

            const start = (page - 1) * collegesPerPage;
            const end = start + collegesPerPage;
            const paginatedData = colleges.slice(start, end);

            if (!colleges || colleges.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No colleges found</td></tr>';
                return;
            }

            tableBody.innerHTML = paginatedData.map(college => `
                <tr>
                    <td><strong>${college.college_name}</strong></td>
                    <td><span class="badge bg-primary">${college.user_count}</span></td>
                    <td><span class="badge bg-info">${college.listing_count}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="alert('View details for ${college.college_name}')">
                            <i class="fas fa-eye me-1"></i>View
                        </button>
                    </td>
                </tr>
            `).join('');

            updateCollegesPagination(colleges.length, page);
        }

        function updateCollegesPagination(total, currentPage) {
            const totalPages = Math.ceil(total / collegesPerPage);
            const start = total === 0 ? 0 : (currentPage - 1) * collegesPerPage + 1;
            const end = Math.min(currentPage * collegesPerPage, total);

            document.getElementById('collegeStart').textContent = start;
            document.getElementById('collegeEnd').textContent = end;
            document.getElementById('collegeTotal').textContent = total;

            document.getElementById('collegePrevPage').disabled = currentPage === 1;
            document.getElementById('collegeNextPage').disabled = currentPage === totalPages || totalPages === 0;
        }

        // ======================
        // CHARTS
        // ======================
        function initCharts() {
            if (typeof Chart === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = renderCharts;
                document.head.appendChild(script);
            } else {
                renderCharts();
            }
        }

        function renderCharts() {
            fetch('/admin/stats', { credentials: 'same-origin' })
            .then(response => response.json())
            .then(data => {
                // User Growth Chart
                if (data.user_growth && data.user_growth.length > 0) {
                    const ctx = document.getElementById('userGrowthChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.user_growth.map(item => item.date),
                                datasets: [{
                                    label: 'New Users',
                                    data: data.user_growth.map(item => item.count),
                                    borderColor: '#6C5CE7',
                                    backgroundColor: 'rgba(108, 92, 231, 0.1)',
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    }
                }

                // Listing Growth Chart
                if (data.listing_growth && data.listing_growth.length > 0) {
                    const ctx = document.getElementById('listingGrowthChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.listing_growth.map(item => item.date),
                                datasets: [{
                                    label: 'New Listings',
                                    data: data.listing_growth.map(item => item.count),
                                    borderColor: '#00B894',
                                    backgroundColor: 'rgba(0, 184, 148, 0.1)',
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    }
                }

                // Category Distribution
                if (data.category_distribution && data.category_distribution.length > 0) {
                    const ctx = document.getElementById('categoryChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: data.category_distribution.map(item => item.category),
                                datasets: [{
                                    data: data.category_distribution.map(item => item.count),
                                    backgroundColor: ['#6C5CE7', '#00B894', '#FDCB6E', '#E17055', '#0984E3']
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    }
                }
            })
            .catch(error => console.error('Error loading chart data:', error));
        }

        function createSalesCharts(data) {
            if (typeof Chart === 'undefined') return;
            if (salesChartsInitialized) return;

            // Sales by Category
            if (data.sales_by_category && data.sales_by_category.length > 0) {
                const ctx = document.getElementById('salesByCategoryChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.sales_by_category.map(item => item.category.toUpperCase()),
                            datasets: [{
                                data: data.sales_by_category.map(item => item.count),
                                backgroundColor: ['#6C5CE7', '#00B894', '#FDCB6E', '#E17055', '#0984E3', '#E84393']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
            }

            salesChartsInitialized = true;
        }

        // ======================
        // EVENT LISTENERS
        // ======================
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminData();

            // Sales filter
            document.getElementById('salesStatusFilter')?.addEventListener('change', function() {
                const filterValue = this.value;
                let filteredData = filterValue === '' ? allSalesData : allSalesData.filter(sale => sale.status === filterValue);
                displaySalesTable(filteredData, 1);
            });

            // Sales pagination
            document.getElementById('salesPrevPage')?.addEventListener('click', function() {
                if (currentSalesPage > 1) {
                    currentSalesPage--;
                    const filterValue = document.getElementById('salesStatusFilter').value;
                    let filteredData = filterValue === '' ? allSalesData : allSalesData.filter(sale => sale.status === filterValue);
                    displaySalesTable(filteredData, currentSalesPage);
                }
            });

            document.getElementById('salesNextPage')?.addEventListener('click', function() {
                const filterValue = document.getElementById('salesStatusFilter').value;
                let filteredData = filterValue === '' ? allSalesData : allSalesData.filter(sale => sale.status === filterValue);
                const totalPages = Math.ceil(filteredData.length / salesPerPage);

                if (currentSalesPage < totalPages) {
                    currentSalesPage++;
                    displaySalesTable(filteredData, currentSalesPage);
                }
            });

            // Users pagination
            document.getElementById('userPrevPage')?.addEventListener('click', () => {
                if (currentUserPage > 1) loadAdminUsers(currentUserPage - 1);
            });

            document.getElementById('userNextPage')?.addEventListener('click', () => {
                loadAdminUsers(currentUserPage + 1);
            });

            // Listings pagination
            document.getElementById('listingPrevPage')?.addEventListener('click', () => {
                if (currentListingPage > 1) loadAdminListings(currentListingPage - 1);
            });

            document.getElementById('listingNextPage')?.addEventListener('click', () => {
                loadAdminListings(currentListingPage + 1);
            });

            // Colleges pagination
            document.getElementById('collegePrevPage')?.addEventListener('click', () => {
                if (currentCollegePage > 1) {
                    currentCollegePage--;
                    displayCollegesTable(allCollegesData, currentCollegePage);
                }
            });

            document.getElementById('collegeNextPage')?.addEventListener('click', () => {
                const totalPages = Math.ceil(allCollegesData.length / collegesPerPage);
                if (currentCollegePage < totalPages) {
                    currentCollegePage++;
                    displayCollegesTable(allCollegesData, currentCollegePage);
                }
            });
        });
    </script>
</body>
</html>
